# 2025-10-03 - Notion API 2025-09-03 Migration

## Session Overview

Implementing breaking changes for Notion's new 2025-09-03 API version, which introduces the data sources concept. This is the first major API version upgrade since 2022-06-28, fundamentally changing how databases work in the Notion API.

## Background

### The Data Sources Concept

Notion is evolving databases from single tables into **containers** that can hold multiple **data sources** (tables), each with their own schema (properties). This enables more flexible data organization within a single database.

**Key Change**:
- **Before**: Database = single table with properties
- **After**: Database = container with 1+ data sources, each with own properties

**Hierarchy**:
```
Database (container)
├── Data Source 1 (schema: Name, Status, Tags)
│   ├── Page (row)
│   └── Page (row)
└── Data Source 2 (schema: Title, Priority, Owner)
    ├── Page (row)
    └── Page (row)
```

### Breaking Changes

1. **Endpoint restructuring**: Most database operations move to `/v1/data_sources/*`
2. **Query operations**: Now query data sources, not databases
3. **Page parents**: Use `data_source_id` instead of `database_id`
4. **Create database**: Properties moved to `initial_data_source.properties`
5. **Search API**: Filter by `"data_source"` instead of `"database"`

## Migration Strategy

### No Backward Compatibility

We're taking a clean-break approach:
- ✅ Only support API version `2025-09-03` (hardcoded)
- ✅ Remove all `database_id` parent support
- ✅ Focus on the new data source paradigm
- ✅ Simpler codebase, clearer API surface

This is acceptable because:
- Project is pre-1.0, no production users yet
- Cleaner architecture without compatibility layers
- Easier to maintain and test

## Reference Documentation

Created comprehensive migration summary: `@reference/notion-api/upgrading_to_2025_09_03/migration_summary.md`

This condenses the official upgrade guide and FAQ into actionable implementation checklist.

## Implementation Plan

### Phase 1: Core Models
1. Create `DataSource` data class (similar to `Database`)
2. Add `dataSources: List<DataSourceRef>` to `Database` model
3. Update `PageParent` to support `data_source_id` type (remove `database_id`)
4. Update `RelationPropertyConfig` to include `data_source_id`
5. Update `SearchFilter` enum: `database` → `data_source`

### Phase 2: API Implementation
1. Create new `DataSourcesApi` with full CRUD operations:
   - `retrieve(dataSourceId: String): DataSource`
   - `query(dataSourceId: String, ...): PaginatedList<Page>`
   - `create(databaseId: String, ...): DataSource`
   - `update(dataSourceId: String, ...): DataSource`
2. Modify `DatabasesApi` for container-level operations:
   - `retrieve()` - returns container with `data_sources` array
   - `create()` - accepts `initial_data_source` parameter
   - `update()` - only container fields (parent, title, icon, cover)
3. Update `PagesApi` to use `data_source_id` parents
4. Update `SearchApi` for data source filtering

### Phase 3: DSL Builders
1. Create `CreateDataSourceRequestBuilder`
2. Create `UpdateDataSourceRequestBuilder`
3. Update `CreateDatabaseRequestBuilder` for `initial_data_source` structure
4. Update parent builders (remove `database_id`, add `data_source_id`)

### Phase 4: Testing Infrastructure
1. Add 2025-09-03 sample responses to `src/test/resources/api/`
2. Update `TestFixtures` with data source samples
3. Add `MockResponseBuilder` helpers for data sources
4. Write comprehensive unit tests for all new models and builders

### Phase 5: Integration Tests (Critical)
Comprehensive real-world API testing:
- Create database with initial data source
- Retrieve database and access data sources
- Query data source (not database)
- Create page with `data_source_id` parent
- Update data source properties
- Create second data source for existing database
- Update database container (move parent, change icon)
- Search for data sources
- Relation properties with data source IDs

### Phase 6: Existing Code Updates
1. Update all existing tests to use data source paradigm
2. Update HTTP client to use `Notion-Version: 2025-09-03` header
3. Review and update any hardcoded assumptions about databases

## Success Criteria

- ✅ All new models serialize/deserialize correctly with official samples
- ✅ `DataSourcesApi` provides full CRUD functionality
- ✅ DSL builders maintain feature parity with existing builders
- ✅ Integration tests validate real API behavior
- ✅ Existing unit tests updated and passing
- ✅ No references to old `database_id` parent type remain

## Expected Challenges

1. **Sample response availability**: May need to generate our own 2025-09-03 samples via API
2. **Multi-source scenarios**: Testing with multiple data sources requires careful setup
3. **Relation properties**: Both `database_id` and `data_source_id` handling
4. **Parent hierarchy**: Understanding `database_parent` vs `parent` in data sources

## Notes

- Webhooks: Not implementing webhook support yet, but event structure documented
- Wikis: Won't support multiple data sources (Notion limitation)
- Permissions: Managed at database level, not per data source
- No changes to: Blocks, Comments, File Uploads, Users, Authentication

---

## Status

**Phase**: Planning Complete
**Next Action**: Begin Phase 1 - Core Models implementation
