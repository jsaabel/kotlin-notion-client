# Development Journal - February 1, 2026

## v0.3 Release Planning

### Objective
Plan the 0.3 release of kotlin-notion-client, focusing on dependency updates and new Notion API features.

---

## Phase 1: Dependency Updates

| Dependency | Current | Latest | Notes |
|------------|---------|--------|-------|
| Kotlin | 2.2.21 | **2.3.0** | Major update |
| Ktor | 3.3.1 | **3.4.0** | HTTP client |
| Kotest | 6.0.4 | **6.1.2** | Test framework |
| kotlinx-datetime | 0.6.2 | 0.7.x? | **Investigate**: 0.7.x uses `kotlin.time.Instant` which may now be stable in Kotlin 2.3 |
| logback | 1.5.20 | 1.5.27 | Logging |
| maven-publish | 0.34.0 | 0.36.0 | Publishing plugin |

**Action**: After Kotlin 2.3 upgrade, check if `kotlin.time.Instant` is no longer `@ExperimentalTime` - if stable, upgrade kotlinx-datetime to 0.7.x.

---

## Phase 2: New Pages API Features

### 2a. Move Page Endpoint (New)
- **Endpoint**: `POST /v1/pages/{page_id}/move`
- **Implementation**: Add `move(pageId, parent)` method to `PagesApi`
- **Models**: `MovePageRequest` with `parent` (page_id or data_source_id)
- **Reference**: `reference/notion-api/documentation/endpoints/Move_Page.md`

### 2b. Create Page Enhancements
- **Template parameter**: `template { type, template_id? }`
- **Position parameter**: `position { type: after_block|page_start|page_end, after_block? }`
- **data_source_id parent type** (may already be partially there via DataSourcesApi)
- **Models**: Update `CreatePageRequest`, `CreatePageRequestBuilder`
- **Reference**: `reference/notion-api/documentation/endpoints/Create_Page_2025.md`

### 2c. Update Page Enhancements
- **`is_locked`** property (boolean)
- **`erase_content`** flag (boolean)
- **`template`** parameter (same structure as create)
- **Models**: Update `UpdatePageRequest`, `UpdatePageRequestBuilder`
- **Reference**: `reference/notion-api/documentation/endpoints/Update_Page_2025.md`

---

## Phase 3: Templates API

- **New endpoint**: `GET /v1/data_sources/{data_source_id}/templates`
- **Response model**: `TemplatesResponse { templates: List<Template>, has_more, next_cursor }`
- **Template model**: `Template { id, name, is_default }`
- **Implementation**: Add `listTemplates(dataSourceId)` to `DataSourcesApi`
- **Reference**: `reference/notion-api/documentation/general/11_Creating_Pages_From_Templates.md`

---

## Phase 4: Query Filters (Lower Priority)

- **Timestamp filters**: Filter by `created_time` or `last_edited_time` page metadata
  - Different from date property filters (no property name, applies to page itself)
  - Uses date filter conditions but with special `timestamp` filter type
  - Reference: `reference/notion-api/documentation/general/07_Filter_Database_Entries.md`

---

## Phase 5: Page Object Model Updates

- Add `is_locked: Boolean?` to `Page` model if not present
- Verify all new response fields are handled

---

## Reference Documentation Added

New documentation saved during this planning session:
- `reference/notion-api/documentation/general/11_Creating_Pages_From_Templates.md`
- `reference/notion-api/documentation/endpoints/Create_Page_2025.md`
- `reference/notion-api/documentation/endpoints/Update_Page_2025.md`
- `reference/notion-api/documentation/endpoints/Move_Page.md`

---

## Suggested Order of Work

1. **Dependency updates** (can be done first, low risk)
2. **Verify integration tests still work** (sanity check before changes)
3. **Page model updates** (`is_locked` property)
4. **Move page endpoint** (new, self-contained)
5. **Update page enhancements** (`is_locked`, `erase_content`, `template`)
6. **Create page enhancements** (`template`, `position`)
7. **Templates API** (list templates endpoint)
8. **Timestamp filters** (if time permits)

---

## Status

- [x] Requirements gathering
- [x] API documentation review
- [x] Reference docs saved
- [x] Dependency updates (except kotlinx-datetime)
- [x] kotlinx-datetime 0.7.x migration
- [ ] Integration test verification
- [ ] Implementation
- [ ] Testing
- [ ] Release

---

## Session Notes

### Dependency Update Analysis (Feb 1, 2026)

#### Ktor 3.4.0 - No Action Required
- SwaggerUI/OpenAPI changes: Not relevant (client-only library)
- Token caching behavior: Not affected (static bearer tokens via `loadTokens`)
- HttpStatement execution context: Standard patterns, no impact expected

#### Kotlin 2.3.0 - Key Finding
- **`kotlin.time.Instant` is now STABLE** - no longer `@ExperimentalTime`
- This enables upgrading kotlinx-datetime to 0.7.x as planned
- No breaking changes affecting this JVM-only library

#### Kotest 6.x Upgrade Side Effect
- Smart-cast contracts improved - triggered warnings for unnecessary `!!` and casts
- Fixed in test files: `NotionApiLimitsTest`, `PagePropertyPlaceTest`, `PagePropertyUniqueIdTest`, `PagePropertyUnknownTypeTest`

### Dependencies Updated
| Dependency | From | To |
|------------|------|-----|
| Kotlin | 2.2.21 | 2.3.0 |
| Ktor | 3.3.1 | 3.4.0 |
| Kotest | 6.0.4 | 6.1.2 |
| logback | 1.5.20 | 1.5.27 |
| maven-publish | 0.34.0 | 0.36.0 |
| kotlinx-datetime | 0.6.2 | 0.7.1 |

### kotlinx-datetime 0.7.1 Migration - Complete
- Upgraded from 0.6.2 to 0.7.1
- Migrated imports from `kotlinx.datetime.Instant` to `kotlin.time.Instant` (now stable in Kotlin 2.3)
- Breaking change: `TimeZone.UTC.id` now returns `"UTC"` instead of `"Z"` - fixed test assertion in `RichTextBuilderTest.kt`
- All tests pass, integration verified with `TypedDatePropertiesIntegrationTest`

---

### Implementation Session (Feb 1, 2026 - Session 2)

#### Completed
1. **Page model** - Added `isLocked: Boolean = false` field to `Page.kt`

2. **New model classes in `PageRequests.kt`**:
   - `MovePageRequest` + `MovePageParent` (sealed class with `PageParent`, `DataSourceParent`)
   - `PageTemplate` (sealed class: `None`, `Default`, `TemplateId`)
   - `PagePosition` (sealed class: `AfterBlock`, `PageStart`, `PageEnd`)

3. **Updated request models**:
   - `UpdatePageRequest` - Added `isLocked`, `template`, `eraseContent` fields
   - `CreatePageRequest` - Added `template`, `position` fields

4. **PagesApi move endpoint**:
   - `move(pageId, parent: MovePageParent)` - Core method
   - `moveToPage(pageId, parentPageId)` - Convenience wrapper
   - `moveToDataSource(pageId, dataSourceId)` - Convenience wrapper

5. **UpdatePageRequestBuilder DSL**:
   - Added `lock()`, `unlock()`, `eraseContent()` methods
   - Added `TemplateBuilder` inner class with `default()`, `byId(templateId)` methods
   - Updated `build()` to include new fields

#### Remaining Work
1. **CreatePageRequestBuilder DSL** - Add template and position builders:
   - Add `templateValue` and `positionValue` private fields
   - Add `template` builder (same pattern as UpdatePageRequestBuilder)
   - Add `position` builder with `afterBlock(blockId)`, `pageStart()`, `pageEnd()` methods
   - Update `build()` to include new fields
   - Add validation: template + children are mutually exclusive

2. **Unit tests** for new functionality:
   - Move page request serialization
   - Template/position serialization
   - Builder DSL tests

3. **Templates API** (Phase 3) - Not started

4. **Timestamp filters** (Phase 4) - Not started

#### Files Modified
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/pages/Page.kt`
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/pages/PageRequests.kt`
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/pages/UpdatePageRequestBuilder.kt`
- `src/main/kotlin/it/saabel/kotlinnotionclient/api/PagesApi.kt`

---

### Implementation Session (Feb 2, 2026 - Session 3)

#### Completed

6. **CreatePageRequestBuilder DSL**:
   - Added `templateValue` and `positionValue` private fields
   - Added `TemplateBuilder` inner class with `none()`, `default()`, `byId(templateId)` methods
   - Added `PositionBuilder` inner class with `afterBlock(blockId)`, `pageStart()`, `pageEnd()` methods
   - Updated `build()` to include `template` and `position` fields
   - Added validation: template + children are mutually exclusive

7. **Unit tests for CreatePageRequestBuilder**:
   - Template configuration tests (none, default, byId, null when not specified)
   - Position configuration tests (afterBlock, pageStart, pageEnd, null when not specified)
   - Validation test for template + children mutual exclusivity

8. **Unit tests for UpdatePageRequestBuilder**:
   - `lock()`, `lock(true)`, `lock(false)`, `unlock()` tests
   - `eraseContent()`, `eraseContent(true)`, `eraseContent(false)` tests
   - `template.default()`, `template.byId()` tests
   - Comprehensive test with all new fields

9. **Integration tests** (separate files for better organization):
   - `PageMoveIntegrationTest.kt` - Tests moveToPage() and moveToDataSource()
   - `PageLockIntegrationTest.kt` - Tests lock()/unlock() functionality
   - `PagePositionIntegrationTest.kt` - Tests position.pageStart()/pageEnd()
   - All tests include URLs in output for easy manual verification
   - All integration tests verified working against live Notion API

#### Files Created/Modified
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/pages/CreatePageRequestBuilder.kt`
- `src/test/kotlin/unit/dsl/PageRequestBuilderTest.kt`
- `src/test/kotlin/pages/UpdatePageRequestBuilderTest.kt`
- `src/test/kotlin/integration/PageMoveIntegrationTest.kt` (new)
- `src/test/kotlin/integration/PageLockIntegrationTest.kt` (new)
- `src/test/kotlin/integration/PagePositionIntegrationTest.kt` (new)

#### Build Status
- All unit tests passing
- All integration tests verified working
- No compilation warnings or errors

#### Remaining Work
1. **Templates API** (Phase 3) - List templates endpoint
2. **Timestamp filters** (Phase 4) - Filter by created_time/last_edited_time
3. Template integration tests (deferred until Templates API is implemented)

#### Notes
- Jupyter notebook serialization issue identified (IntelliJ's bundled Kotlin kernel uses older kotlinx-serialization)
- Issue is separate from v0.3 development and will be addressed later
- All new functionality verified working through integration tests

---

### Implementation Session (Feb 2, 2026 - Session 4 - Templates API)

#### Completed

**Phase 3: Templates API - Complete ✅**

10. **Model classes** (`DataSource.kt`):
    - Added `Template` data class with `id`, `name`, `isDefault` fields
    - Added `TemplatesResponse` for paginated template listings

11. **DataSourcesApi implementation**:
    - Added `listTemplates(dataSourceId, nameFilter?)` method
    - Automatic pagination handling (fetches all pages)
    - Optional name filtering (case-insensitive substring match)
    - Safety checks to prevent infinite pagination loops
    - Follows existing error handling patterns

12. **Test resources and fixtures**:
    - Created `get_list_data_source_templates.json` sample response
    - Added helper methods to `TestFixtures.DataSources`

13. **Unit tests** (`DataSourcesApiTest.kt`):
    - Model deserialization test
    - Basic listing functionality
    - Name filter functionality
    - Pagination handling (multi-page test)
    - Error scenarios (404, 403)
    - All 6 tests passing ✅

14. **Integration tests**:
    - **Basic test** (`DataSourcesIntegrationTest.kt`): Lists templates from dynamically created database (finds 0, verifies API works)
    - **Comprehensive tests** (`TemplatesIntegrationTest.kt` - new file): 7 tests requiring pre-configured data source
      - List templates with detailed output
      - Filter templates by name
      - Create page using default template
      - Create page using specific template ID
      - Apply template with/without eraseContent (side-by-side comparison)
      - Apply template to existing page
      - Batch creation (multiple pages from same template)
    - All tests include URLs for easy manual verification
    - Tests handle edge cases (no default template, etc.)

#### Environment Setup for Advanced Tests
- Requires `NOTION_TEMPLATES_DATA_SOURCE_ID` environment variable
- Data source should have 2-3 templates with at least one marked as default
- Full setup instructions documented in test file comments

#### Files Created/Modified
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/datasources/DataSource.kt`
- `src/main/kotlin/it/saabel/kotlinnotionclient/api/DataSourcesApi.kt`
- `src/test/resources/api/data_sources/get_list_data_source_templates.json` (new)
- `src/test/kotlin/unit/util/TestFixtures.kt`
- `src/test/kotlin/unit/api/DataSourcesApiTest.kt` (new)
- `src/test/kotlin/integration/DataSourcesIntegrationTest.kt`
- `src/test/kotlin/integration/TemplatesIntegrationTest.kt` (new)

#### Build Status
- All unit tests passing (40+ tests) ✅
- Code formatted and linted ✅
- Build successful ✅

#### Remaining Work
1. **Timestamp filters** (Phase 4) - Filter by created_time/last_edited_time

#### Key Decisions
- Separated basic template test (always runs) from comprehensive tests (requires setup)
- Used pragmatic approach for testing: manual data source setup via env var since templates can't be created via API
- Added eraseContent comparison test showing side-by-side behavior difference

---

### Implementation Session (Feb 8, 2026 - Session 5 - Timestamp Filters)

#### Completed

**Phase 4: Timestamp Filters - Complete ✅**

15. **Model updates** (`DataSourceQuery.kt`):
    - Added `timestamp`, `createdTime`, `lastEditedTime` fields to `DataSourceFilter`
    - Enables filtering by page creation/modification timestamps

16. **TimestampFilterBuilder** (`DataSourceQueryBuilder.kt`):
    - Created comprehensive builder for timestamp filtering
    - String-based methods: `equals()`, `before()`, `after()`, `onOrBefore()`, `onOrAfter()`
    - Typed overloads for `LocalDate`, `LocalDateTime`, and `Instant`
    - Relative date filters: `isEmpty()`, `isNotEmpty()`, `pastWeek()`, `pastMonth()`, `pastYear()`, `nextWeek()`, `nextMonth()`, `nextYear()`
    - Added `createdTime()` and `lastEditedTime()` methods to `FilterBuilder`

17. **Unit tests**:
    - `TimestampFilterSerializationTest.kt` - 8 tests for JSON serialization
    - Updated `DataSourceQueryBuilderTest.kt` - 4 new tests for builder usage
    - All tests passing ✅

18. **Integration test decisions**:
    - Created initial integration tests but encountered timing issues
    - Notion API doesn't store pages with distinct timestamps when created seconds apart
    - Created sanity check test requiring manual database setup
    - Decided to remove integration tests as they're awkward to test reliably
    - Timestamp filters verified working through manual testing

#### Files Modified
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/datasources/DataSourceQuery.kt`
- `src/main/kotlin/it/saabel/kotlinnotionclient/models/datasources/DataSourceQueryBuilder.kt`
- `src/test/kotlin/unit/query/DataSourceQueryBuilderTest.kt`
- `src/test/kotlin/unit/query/TimestampFilterSerializationTest.kt` (new)

#### Commit
- `553200b` - `feat: add timestamp filters for data source queries`

#### v0.3 Release Status
All planned phases complete:
- [x] Phase 1: Dependency updates
- [x] Phase 2: Pages API enhancements (move, lock, position, template)
- [x] Phase 3: Templates API
- [x] Phase 4: Timestamp filters

---

### Pre-Release Issues (Feb 8, 2026 - Session 6)

#### Issue: Kotlin Notebook Examples Not Working

**Problem Identified:**
- Jupyter notebook `notebooks/01-getting-started.ipynb` failing
- First failure observed: "Example 1: Get Current User Information"
- Notebooks currently reference version 0.2.0
- Need to investigate root cause before v0.3 release

**Investigation Status:**
- [x] Determine exact failure mode and error messages
- [x] Check if issue is version-related (0.2.0 vs unreleased 0.3.0)
- [x] Check if kotlinx-datetime migration (0.6.2 → 0.7.1) affects notebooks
- [x] Test other notebook examples for failures

**Root Cause Identified:**
- Error: `io.ktor.serialization.JsonConvertException: Illegal input: 'kotlinx.serialization.KSerializer[] kotlinx.serialization.internal.GeneratedSerializer.typeParametersSerializers()'`
- This is a **binary incompatibility** between kotlinx-serialization versions
- The Jupyter Kotlin kernel has its own bundled kotlinx-serialization version
- Adding `@file:DependsOn("org.jetbrains.kotlinx:kotlinx-serialization-json:1.9.0")` before library import **does not resolve** the issue
- The kernel's classloader prioritizes its bundled version over `@file:DependsOn` declarations

**Verification:**
- Created `NotebookValidationTest.kt` integration test replicating notebook Example 1
- Test **passes successfully** ✅ - confirms library code and serialization work correctly
- Issue is confirmed to be **notebook environment-specific**, not a library bug

**Attempted Fixes:**
1. ✅ Added explicit `@file:DependsOn("org.jetbrains.kotlinx:kotlinx-serialization-json:1.9.0")` - **Failed**
2. ✅ Published v0.3.0 to Maven Local with kotlinx-serialization 1.10.0 - **Failed**
3. ✅ Added `@file:Repository("*mavenLocal")` to load local version - **Failed**
4. ✅ Updated to kotlinx-serialization 1.10.0 in notebook - **Failed**

**Conclusion:**
The Jupyter Kotlin kernel's classloader **always prioritizes** its bundled kotlinx-serialization version over `@file:DependsOn` declarations. This is a fundamental kernel limitation, not solvable through dependency management in notebooks.

**Decision: Option B - Document Limitation & Release**

After extensive debugging, determined the issue is unfixable with current IntelliJ Kotlin Notebook kernel (0.12.0-398):
- Kernel uses shadowed kotlinx-serialization that takes precedence over all `@file:DependsOn` declarations
- Ktor 3.4.0 (from our library) conflicts with kernel's shadowed kotlinx-serialization
- Triple version conflict: Library + Ktor + Kernel shadowed jar
- Integration tests prove library works perfectly outside notebooks

**Decision**: Document as known limitation, release v0.3 without notebook support.

**Post-Decision Cleanup (Feb 8, 2026)**:
- Reverted kotlinx-serialization back to 1.10.0 (latest) since notebook compatibility attempt abandoned
- All tests pass with 1.10.0 ✅
- Library ready for release with latest dependency versions

---

## v0.3 Release Preparation Tasks

### 1. Documentation Updates
- [ ] Update README with v0.3 features
- [ ] Write release notes/changelog
- [ ] Document notebook limitation
- [ ] Update version references in docs

### 2. Code Cleanup
- [ ] Address TODOs in test files (e.g., PageRequestBuilderTest.kt)
- [ ] Remove/update commented-out test blocks
- [ ] Re-enable signing in build.gradle.kts
- [ ] Clean up debug code from notebooks

### 3. Final Verification
- [ ] Run full test suite
- [ ] Verify build succeeds
- [ ] Check no uncommitted changes remain

### 4. Release
- [ ] Tag version 0.3.0
- [ ] Publish to Maven Central
